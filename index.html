<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nitro Type Top 1000 Racers</title>

  <style>
    /* Nitro Type Leaderboard — Dark, fast, responsive */

    :root {
      --bg: #111317;
      --surface: #151922;
      --surface-2: #1b2130;
      --surface-3: #212838;
      --text: #e8ecf1;
      --text-dim: #b5c0cf;
      --muted: #8b9ab3;
      --accent: #6ea8fe;
      --accent-2: #8fdaff;
      --good: #37d67a;
      --warn: #ffb020;
      --bad: #ff5c5c;
      --border: #2a3244;
      --shadow: rgba(0,0,0,0.35);
      --focus: #82b1ff;

      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;

      --pad-1: 0.4rem;
      --pad-2: 0.66rem;
      --pad-3: 1rem;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Base */
    *,
    *::before,
    *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: var(--font);
      background: radial-gradient(1000px 600px at 20% -10%, #162037 0%, var(--bg) 60%) no-repeat fixed;
      color: var(--text);
      line-height: 1.35;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: var(--pad-3);
    }

    /* Header */
    header {
      text-align: center;
      padding: 16px 12px;
      margin: 0 auto var(--pad-3);
      max-width: 1200px;
      background: linear-gradient(180deg, rgba(33,40,56,0.75), rgba(27,33,48,0.75));
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    header h1 {
      margin: 0 0 6px;
      font-weight: 800;
      letter-spacing: 0.2px;
      color: #f0f5ff;
      text-shadow: 0 6px 18px rgba(110,168,254,0.18);
    }
    header p { margin: 2px 0; color: var(--text-dim); }
    header a { color: var(--accent); text-decoration: none; }
    header a:hover { color: var(--accent-2); }

    /* Tabs */
    .tabs {
      display: grid;
      grid-template-columns: repeat(4, minmax(140px, 1fr));
      gap: var(--pad-2);
      align-items: stretch;
      margin: 0 auto var(--pad-3);
      max-width: 1200px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .tabs .tab {
      background: linear-gradient(180deg, var(--surface-3), var(--surface-2));
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.6rem 0.8rem;
      text-align: center;
      font-weight: 700;
      letter-spacing: 0.15px;
      cursor: pointer;
      user-select: none;
      transition: transform .04s ease, box-shadow .15s ease, border-color .15s ease;
      box-shadow: 0 2px 0 var(--shadow) inset, 0 0 0 rgba(0,0,0,0);
      white-space: nowrap;
    }
    .tabs .tab:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.35), 0 0 0 1px rgba(255,255,255,0.03) inset;
    }
    .tabs .tab.active {
      color: #ffffff;
      border-color: var(--focus);
      text-shadow: 0 0 10px rgba(110,168,254,0.6);
    }

    /* Sections */
    .table-container {
      display: none;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 10px;
      margin: 0 auto 40px;
      max-width: 1200px;
      overflow: visible;
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
    }
    .table-container.active { display: block; }

    /* Table scroller for wide tables */
    .table-scroller {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .table-scroller table {
      min-width: max-content;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
      font-size: 0.92rem;
    }
    thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: linear-gradient(180deg, var(--surface-3), var(--surface-2));
      color: var(--text);
      font-weight: 700;
      letter-spacing: 0.15px;
      padding: 0.6rem 0.66rem;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum";
    }
    thead th.asc,
    thead th.desc {
      color: #ffffff;
      text-shadow: 0 0 10px rgba(110,168,254,0.6);
    }

    /* Sort arrows */
    thead th::after {
      content: '';
      display: inline-block;
      margin-left: 6px;
      width: 0;
      height: 0;
      vertical-align: middle;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
    }
    thead th.asc::after { border-bottom: 7px solid var(--accent); }
    thead th.desc::after { border-top: 7px solid var(--accent); }

    thead th:first-child,
    thead th:nth-child(2),
    thead th:nth-child(3) { text-align: left; }

    tbody td {
      padding: 0.56rem 0.66rem;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      color: var(--text);
      text-align: right;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum";
    }
    tbody tr:nth-child(even) { background: rgba(255,255,255,0.025); }
    tbody tr:hover { background: linear-gradient(90deg, rgba(110,168,254,0.08), rgba(110,168,254,0)); }
    tbody td:first-child,
    tbody td:nth-child(2),
    tbody td:nth-child(3) { text-align: left; }

    /* Link utilities (white underline) */
    a.link-quiet, a.link-quiet:visited {
      color: #fff;
      text-decoration: underline;
      text-decoration-color: rgba(255,255,255,0.9);
      text-underline-offset: 2px;
    }
    a.link-quiet:hover { text-decoration-color: #fff; }
    a.tag-link, a.tag-link:visited {
      color: #fff;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    a.tag-link:hover { text-decoration-color: #fff; }

    /* Notes */
    .note {
      color: #e8ecf1;
      font-size: 0.95rem;
      text-align: center;
      margin: 6px 0 10px;
    }
    .hidden { display: none !important; }

    /* Responsive stacked cards */
    @media (max-width: 900px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tr { margin-bottom: 15px; }
      td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
      }
      td::before {
        content: attr(data-label);
        flex: 1 1 40%;
        color: var(--text-dim);
        font-weight: 700;
        text-transform: uppercase;
      }
      td span, td a, td div {
        flex: 1 1 60%;
        text-align: right;
      }
    }

    /* A11y */
    :focus-visible {
      outline: 3px solid rgba(130,177,255,0.35);
      outline-offset: 2px;
      border-radius: 8px;
    }
    @media (prefers-reduced-motion: reduce) { * { transition: none !important; } }

    /* Scrollbar (WebKit) */
    ::-webkit-scrollbar { height: 12px; width: 12px; }
    ::-webkit-scrollbar-track { background: var(--surface); }
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #3a4560, #2b344a);
      border-radius: 10px;
      border: 2px solid var(--surface);
    }
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #4b5a7c, #37415a);
    }
  </style>
</head>

<body>
  <header>
    <h1>Nitro Type Top 1000 Racers</h1>
    <p>
      made by
      <a href="https://www.youtube.com/@InternetTyper" target="_blank">
        @InternetTyper on YouTube
      </a>
    </p>
    <p id="lastUpdated">Last updated: Join https://discord.gg/3XVdxvKgAt To Find Out</p>
    <p>Contact: https://discord.gg/3XVdxvKgAt on Discord</p>
  </header>

  <div class="tabs">
    <div class="tab active" data-target="leaderboardSection">Leaderboard</div>
    <div class="tab" data-target="racesPerDaySection">Races Per Day</div>
    <div class="tab" data-target="changes24Section">24-Hour Leaderboard</div>
    <div class="tab" data-target="eventSection">Event</div>
  </div>

  <!-- Leaderboard -->
  <section id="leaderboardSection" class="table-container active">
    <div class="table-scroller">
      <table id="leaderboardTable">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Display Name</th>
            <th>Team Tag</th>
            <th>Title</th>
            <th>Total Races</th>
            <th>Avg WPM</th>
            <th>Top WPM</th>
            <th>Profile Views</th>
            <th>Member Since</th>
            <th>Garage Cars</th>
            <th>Nitros Used</th>
            <th>Longest Session</th>
            <th>League Tier</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="note" id="leaderboardNote"></p>
  </section>

  <!-- Races Per Day -->
  <section id="racesPerDaySection" class="table-container">
    <div class="table-scroller">
      <table id="racesPerDayTable">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Display Name</th>
            <th>Total Races</th>
            <th>Join Date</th>
            <th>Days Active</th>
            <th>Races / Day</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="note" id="rpdNote"></p>
  </section>

  <!-- 24-Hour Leaderboard -->
  <section id="changes24Section" class="table-container">
    <div class="table-scroller">
      <table id="changes24Table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Display Name</th>
            <th class="desc">Δ Total Races</th>
            <th>Δ Top WPM</th>
            <th>Δ Profile Views</th>
            <th>Δ Nitros Used</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="note" id="dailyNote"></p>
  </section>

  <!-- Event -->
  <section id="eventSection" class="table-container">
    <div class="note" id="eventInfo">Event metrics combine API_before/now and Before/After profile snapshots. Typed/errs are used for accuracy and points but not displayed.</div>
    <div class="note" id="eventStatus"></div>
    <div class="table-scroller">
      <table id="eventTable">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Display Name</th>
            <th>Team Tag</th>
            <th class="desc">Δ Total Races</th>
            <th>Avg WPM</th>
            <th>Avg Accuracy</th>
            <th>Avg Points</th>
            <th>Δ Nitros Used</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  // -----------------------------
  // Constants and configuration
  // -----------------------------
  const MAX_24H_RACES = 2600;          // anomaly cutoff for 24h diffs
  const SECONDS_PER_RACE = 28.47;      // assumed average race duration (s)
  const WPM_METHOD = 'typed';          // 'typed' | 'weighted' | 'current'
  const WPM_RESET_THRESHOLD = 169.6741;     // cap: reset event WPM to API avgWpm if above this
  const EVENT_DEFAULT_SORT = 'totalPoints'; // default sort for Event table
  const EVENT_FILES = {
    apiBefore: 'API_before.ndjson',     // NDJSON lines (API snapshot before)
    apiNow: 'API_now.ndjson',           // NDJSON lines (API snapshot after)
    dataBefore: 'BeforeEventData.json', // Profile snapshot before (Data)
    dataNow: 'AfterEventData.json'      // Profile snapshot after (Data)
  };

  // -----------------------------
  // Remove legacy "Total Points" tab/section and enforce Event header
  // -----------------------------
  removeTotalPointsSectionIfPresent();
  ensureEventHeaderExact(); // ensures exact column order for Event table THEAD

  // -----------------------------
  // Tabs
  // -----------------------------
  const tabs = document.querySelectorAll('.tabs .tab');
  const sections = document.querySelectorAll('.table-container');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      sections.forEach(s => s.classList.remove('active'));
      tab.classList.add('active');
      const targetId = tab.dataset.target;
      const section = document.getElementById(targetId);
      if (section) section.classList.add('active');
    });
  });

  // -----------------------------
  // Main snapshots (current/previous)
  // -----------------------------
  Promise.all([
    fetchJSONFlexible('sample_data.json'),            // current data (Data)
    fetchJSONFlexible('sample_data_prev.json', true)  // previous data (optional)
  ])
  .then(([curData, prevData]) => {
    const cur = normalizeData(curData);
    const prev = normalizeData(prevData);

    // Update last updated if provided
    if (cur.updatedAt) {
      const el = document.getElementById('lastUpdated');
      if (el) {
        const when = new Date(cur.updatedAt);
        el.textContent = isNaN(when.getTime())
          ? `Last updated: ${cur.updatedAt}`
          : `Last updated: ${when.toLocaleString()}`;
      }
    }

    // Leaderboard
    renderLeaderboard(cur.racers);
    enableSorting('leaderboardTable');

    // Races per day
    renderRacesPerDay(cur.racers);
    enableSorting('racesPerDayTable');

    // 24-hour deltas (Data current vs previous)
    const prevMap = new Map((prev.racers || []).map(r => [String(r.username || '').toLowerCase(), r]));
    renderChanges24(cur.racers, prevMap);
    enableSorting('changes24Table');

    // Event (four-file pipeline)
    initEventTab();
  })
  .catch(err => {
    console.error('Failed loading main snapshots:', err);
    const msg = document.createElement('p');
    msg.textContent = 'Error loading main snapshots – check console.';
    msg.style.color = '#ff5c5c';
    msg.style.textAlign = 'center';
    document.body.appendChild(msg);
    initEventTab(); // still try event tab
  });

  // -----------------------------
  // Event initialization (single merged Event table)
  // -----------------------------
  function initEventTab() {
    loadEventFourFiles(EVENT_FILES)
      .then(result => {
        if (!result) {
          clearEventTable();
          setEventStatus('No event data available.');
          return;
        }
        const { rows, beforeCount, nowCount } = result;
        if (!rows || rows.length === 0) {
          clearEventTable();
          setEventStatus(`Loaded ${beforeCount.toLocaleString()} (before API) and ${nowCount.toLocaleString()} (now API); 0 racers with Δ races > 0.`);
          return;
        }

        // Default sort for event table (pre-render)
        const sorted = [...rows].sort((a, b) => {
          if (EVENT_DEFAULT_SORT === 'totalPoints') {
            const av = Number.isFinite(a.totalPoints) ? a.totalPoints : -Infinity;
            const bv = Number.isFinite(b.totalPoints) ? b.totalPoints : -Infinity;
            if (bv !== av) return bv - av;
            if (b.dRaces !== a.dRaces) return b.dRaces - a.dRaces;
            const aw = Number.isFinite(a.wpm) ? a.wpm : -Infinity;
            const bw = Number.isFinite(b.wpm) ? b.wpm : -Infinity;
            return bw - aw;
          } else {
            if (b.dRaces !== a.dRaces) return b.dRaces - a.dRaces;
            const av = Number.isFinite(a.totalPoints) ? a.totalPoints : -Infinity;
            const bv = Number.isFinite(b.totalPoints) ? b.totalPoints : -Infinity;
            if (bv !== av) return bv - av;
            const aw = Number.isFinite(a.wpm) ? a.wpm : -Infinity;
            const bw = Number.isFinite(b.wpm) ? b.wpm : -Infinity;
            return bw - aw;
          }
        });

        // Render Event table (merged with Total Points)
        renderEventComputed(sorted);
        enableSorting('eventTable');
        setEventStatus(`Loaded ${beforeCount.toLocaleString()} (before API) and ${nowCount.toLocaleString()} (now API); ${rows.length.toLocaleString()} racers with Δ races > 0.`);
      })
      .catch(err => {
        console.error('Event computation error:', err);
        clearEventTable();
        setEventStatus('Error loading event data.');
      });
  }

  // -----------------------------
  // Flexible fetch: JSON or NDJSON (including jammed `}{`)
  // -----------------------------
  async function fetchJSONFlexible(url, allowEmpty = false) {
    try {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) {
        if (allowEmpty && (res.status === 404 || res.status === 204)) {
          return { racers: [] };
        }
        throw new Error(`${url}: HTTP ${res.status} ${res.statusText}`);
      }

      const text = (await res.text()).trim();
      if (!text) {
        return allowEmpty ? { racers: [] } : JSON.parse(''); // force catch below
      }

      // Try as single JSON first
      try {
        return JSON.parse(text);
      } catch {
        // Fall through to NDJSON
      }

      // Normalize jammed objects into line-delimited
      const normalized = text.replace(/}\s*{/g, '}\n{');
      const lines = normalized
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(Boolean);

      const arr = [];
      for (const line of lines) {
        try {
          arr.push(JSON.parse(line));
        } catch {
          // skip malformed lines
        }
      }
      return arr;
    } catch (err) {
      if (allowEmpty) return { racers: [] };
      throw err;
    }
  }

  // -----------------------------
  // Normalize Data payload shape
  // -----------------------------
  function normalizeData(payload) {
    if (Array.isArray(payload)) return { updatedAt: null, racers: payload };
    if (payload && Array.isArray(payload.racers)) return { updatedAt: payload.updatedAt || null, racers: payload.racers };
    return { updatedAt: null, racers: [] };
  }

  // -----------------------------
  // Leaderboard render (Data current)
  // -----------------------------
  function renderLeaderboard(data) {
    const list = [...(data || [])].map(r => ({
      slug: String(r.username || ''),
      tag: String(r.tag || ''),
      display: String(r.title || ''),
      title: String(r.title || ''),
      racesPlayed: safeNumber(r.racesPlayed),
      avgSpeed: safeNumber(r.avgSpeed),
      highestSpeed: safeNumber(r.highestSpeed),
      profileViews: safeNumber(r.profileViews),
      joinDate: String(r.joinDate || ''),
      garageCars: safeNumber(r.garageCars),
      nitrosUsed: safeNumber(r.nitrosUsed),
      longestSession: safeNumber(r.longestSession),
      leagueTier: safeNumber(r.leagueTier)
    }));

    list.sort((a, b) => b.racesPlayed - a.racesPlayed);

    const tbody = document.querySelector('#leaderboardTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const frag = document.createDocumentFragment();

    list.forEach((r, i) => {
      const tr = document.createElement('tr');
      const racerUrl = ntRacerURL(r.slug);
      const teamUrl = r.tag ? ntTeamURL(r.tag) : '#';
      tr.innerHTML = `
        <td data-label="Rank">${i + 1}</td>
        <td data-label="Display Name">
          <a class="link-quiet" href="${escapeAttr(racerUrl)}" target="_blank">${escapeHTML(prettyNameFromSlug(r.slug))}</a>
        </td>
        <td data-label="Team Tag">
          ${r.tag ? `<a class="tag-link" href="${escapeAttr(teamUrl)}" target="_blank">${escapeHTML(r.tag)}</a>` : '<span>-</span>'}
        </td>
        <td data-label="Title">${escapeHTML(r.title)}</td>
        <td data-label="Total Races">${r.racesPlayed.toLocaleString()}</td>
        <td data-label="Avg WPM">${r.avgSpeed.toLocaleString()}</td>
        <td data-label="Top WPM">${r.highestSpeed.toLocaleString()}</td>
        <td data-label="Profile Views">${r.profileViews.toLocaleString()}</td>
        <td data-label="Member Since">${escapeHTML(r.joinDate)}</td>
        <td data-label="Garage Cars">${r.garageCars.toLocaleString()}</td>
        <td data-label="Nitros Used">${r.nitrosUsed.toLocaleString()}</td>
        <td data-label="Longest Session">${r.longestSession.toLocaleString()}</td>
        <td data-label="League Tier">${r.leagueTier.toLocaleString()}</td>
      `.trim();
      frag.appendChild(tr);
    });

    tbody.appendChild(frag);
    setNote('leaderboardNote', `${list.length.toLocaleString()} racers loaded.`);
  }

  // -----------------------------
  // Races Per Day (Data current)
  // -----------------------------
  function renderRacesPerDay(data) {
    const now = Date.now();
    const list = (data || []).map(r => {
      const parsed = parseLocalDate(r.joinDate);
      const joined = parsed.getTime();
      const days = Math.max(1, Math.floor((now - joined) / 86400000));
      const total = safeNumber(r.racesPlayed);
      return {
        slug: String(r.username || ''),
        tag: String(r.tag || ''),
        total,
        joinDate: String(r.joinDate || ''),
        days,
        perDay: total / days
      };
    }).sort((a, b) => b.perDay - a.perDay);

    const tbody = document.querySelector('#racesPerDayTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const frag = document.createDocumentFragment();

    list.forEach((r, i) => {
      const racerUrl = ntRacerURL(r.slug);
      const name = prettyNameFromSlug(r.slug);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td data-label="Rank">${i + 1}</td>
        <td data-label="Display Name">
          <a class="link-quiet" href="${escapeAttr(racerUrl)}" target="_blank">${escapeHTML(name)}</a>
        </td>
        <td data-label="Total Races">${r.total.toLocaleString()}</td>
        <td data-label="Join Date">${escapeHTML(r.joinDate)}</td>
        <td data-label="Days Active">${r.days.toLocaleString()}</td>
        <td data-label="Races / Day">${r.perDay.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
      `.trim();
      frag.appendChild(tr);
    });

    tbody.appendChild(frag);
    setNote('rpdNote', `${list.length.toLocaleString()} racers computed.`);
  }

  // -----------------------------
  // 24-Hour diffs (Data current vs previous)
  // -----------------------------
  function renderChanges24(currentRacers, prevMap) {
    const filtered = (currentRacers || []).filter(r => safeNumber(r.racesPlayed) > 0);

    const diffs = filtered.map(r => {
      const key = String(r.username || '').toLowerCase();
      const p = prevMap.get(key) || {};
      const dRaces = safeNumber(r.racesPlayed) - safeNumber(p.racesPlayed);
      const dTop = safeNumber(r.highestSpeed) - safeNumber(p.highestSpeed);
      const dViews = safeNumber(r.profileViews) - safeNumber(p.profileViews);
      const dNitro = safeNumber(r.nitrosUsed) - safeNumber(p.nitrosUsed);
      return {
        slug: String(r.username || ''),
        dRaces, dTop, dViews, dNitro
      };
    })
    .filter(d => d.dRaces !== 0 && d.dRaces < MAX_24H_RACES)
    .sort((a, b) => b.dRaces - a.dRaces);

    const tbody = document.querySelector('#changes24Table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const frag = document.createDocumentFragment();

    diffs.forEach((d, i) => {
      const tr = document.createElement('tr');
      const racerUrl = ntRacerURL(d.slug);
      const name = prettyNameFromSlug(d.slug);
      tr.innerHTML = `
        <td data-label="Rank">${i + 1}</td>
        <td data-label="Display Name"><a class="link-quiet" href="${escapeAttr(racerUrl)}" target="_blank">${escapeHTML(name)}</a></td>
        <td data-label="Δ Total Races">${formatDeltaInt(d.dRaces)}</td>
        <td data-label="Δ Top WPM">${formatDeltaInt(d.dTop)}</td>
        <td data-label="Δ Profile Views">${formatDeltaInt(d.dViews)}</td>
        <td data-label="Δ Nitros Used">${formatDeltaInt(d.dNitro)}</td>
      `.trim();
      frag.appendChild(tr);
    });

    tbody.appendChild(frag);
    setNote('dailyNote', `${diffs.length.toLocaleString()} racers with activity in the last snapshot window.`);
  }

  // -----------------------------
  // Event: four files -> computed period metrics
  // -----------------------------
  async function loadEventFourFiles(files) {
    const [apiBeforeRaw, apiNowRaw, dataBeforeRaw, dataNowRaw] = await Promise.all([
      fetchJSONFlexible(files.apiBefore, true),
      fetchJSONFlexible(files.apiNow, true),
      fetchJSONFlexible(files.dataBefore, true),
      fetchJSONFlexible(files.dataNow, true)
    ]);

    // Normalize API (flat arrays) and Data (object or array)
    const apiBefore = toArray(apiBeforeRaw);
    const apiNow = toArray(apiNowRaw);
    const dataBefore = normalizeData(dataBeforeRaw).racers;
    const dataNow = normalizeData(dataNowRaw).racers;

    const beforeCount = apiBefore.length;
    const nowCount = apiNow.length;

    // Index by lowercase username
    const apiB = indexByKey(apiBefore, o => String(o.username || '').toLowerCase());
    const apiN = indexByKey(apiNow, o => String(o.username || '').toLowerCase());
    const dataB = indexByKey(dataBefore, o => String(o.username || '').toLowerCase());
    const dataN = indexByKey(dataNow, o => String(o.username || '').toLowerCase());

    // Union of keys
    const keys = new Set([
      ...Object.keys(apiB), ...Object.keys(apiN),
      ...Object.keys(dataB), ...Object.keys(dataN)
    ]);

    const rows = [];
    keys.forEach(k => {
      const aB = apiB[k];
      const aN = apiN[k];
      const dB = dataB[k];
      const dN = dataN[k];

      const hasAPI = !!(aB && aN);
      const hasData = !!(dB && dN);

      // Identity
      const slug = pickFirstNonEmpty([
        dN?.username, dB?.username, aN?.username, aB?.username
      ], k);
      const tag = pickFirstNonEmpty([
        dN?.tag, dB?.tag, aN?.teamTag, aB?.teamTag
      ], '');
      const displayName = pickFirstNonEmpty([
        aN?.displayName, aB?.displayName, dN?.username, dB?.username, slug
      ], slug);

      // Δ races: prefer Data delta if available and non-zero; else API lifetimeRaces
      const racesDeltaData = hasData ? (safeNumber(dN.racesPlayed) - safeNumber(dB.racesPlayed)) : 0;
      const racesDeltaAPI = hasAPI ? (safeNumber(aN.lifetimeRaces) - safeNumber(aB.lifetimeRaces)) : 0;
      const dRaces = (hasData && racesDeltaData !== 0) ? racesDeltaData : racesDeltaAPI;
      if (dRaces <= 0) return;

      // Typed/errs deltas for accuracy & typed-based WPM
      const typedDelta = hasAPI ? Math.max(0, safeNumber(aN.typed) - safeNumber(aB.typed)) : 0;
      const errsDelta  = hasAPI ? Math.max(0, safeNumber(aN.errs)  - safeNumber(aB.errs))  : 0;

      // Accuracy (% over the period)
      const acc = (hasAPI && typedDelta > 0)
        ? clamp(0, 100 * (1 - (errsDelta / Math.max(1, typedDelta))), 100)
        : null;

      // Period WPM (with cap/reset above threshold)
      let wpm = null;
      if (hasAPI) {
        if (WPM_METHOD === 'typed') {
          wpm = wpmFromTyped(typedDelta, dRaces, SECONDS_PER_RACE);
          // Fallback if typed/races insufficient
          if (wpm == null) {
            const playedDelta = safeNumber(aN.played) - safeNumber(aB.played);
            wpm = (playedDelta > 0)
              ? (safeNumber(aN.avgWpm) * safeNumber(aN.played) - safeNumber(aB.avgWpm) * safeNumber(aB.played)) / playedDelta
              : safeNumber(aN.avgWpm);
          }
        } else if (WPM_METHOD === 'weighted') {
          const playedDelta = safeNumber(aN.played) - safeNumber(aB.played);
          wpm = (playedDelta > 0)
            ? (safeNumber(aN.avgWpm) * safeNumber(aN.played) - safeNumber(aB.avgWpm) * safeNumber(aB.played)) / playedDelta
            : safeNumber(aN.avgWpm);
        } else {
          wpm = safeNumber(aN.avgWpm);
        }
      }

      // Apply reset if over threshold; preserve audit info
      let wpmReset = false;
      let wpmOriginal = null;
      if (!Number.isFinite(wpm) || wpm < 0) {
        wpm = null;
      } else if (wpm > WPM_RESET_THRESHOLD) {
        const apiAvg = hasAPI ? safeNumber(aN.avgWpm) : 0;
        if (apiAvg > 0) {
          wpmOriginal = wpm;
          wpm = apiAvg;   // reset to API-stored average WPM
          wpmReset = true;
        }
      }

      // Points per race & total points for the period (use possibly reset WPM)
      const pointsPerRace = (wpm != null && acc != null)
        ? 100 + (wpm / 2) * (acc / 100)
        : null;
      const totalPoints = (pointsPerRace != null)
        ? pointsPerRace * dRaces
        : null;

      // Δ Nitros from Data if present
      const nitrosDelta = hasData ? Math.max(0, safeNumber(dN.nitrosUsed) - safeNumber(dB.nitrosUsed)) : null;

      rows.push({
        slug, tag, displayName,
        dRaces, wpm, acc,
        pointsPerRace, totalPoints,
        nitrosDelta,
        wpmReset,        // audit flag
        wpmOriginal      // pre-cap WPM for tooltip
      });
    });

    // Do not sort here; let initEventTab decide default sort
    return { beforeCount, nowCount, rows };
  }

  // -----------------------------
  // Event table render (EXACT COLUMN ORDER)
  // Desired headers:
  // Rank | Display Name | Team Tag | Total Races | Avg WPM | Avg Accuracy | Avg Points | Nitros Used | Total Points
  // -----------------------------
  function renderEventComputed(rows) {
    const tbody = document.querySelector('#eventTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const frag = document.createDocumentFragment();

    rows.forEach((r, i) => {
      const racerUrl = ntRacerURL(r.slug);
      const teamUrl = r.tag ? ntTeamURL(r.tag) : '#';
      const tr = document.createElement('tr');

      const wpmStr = r.wpm != null
        ? safeNumber(r.wpm).toLocaleString(undefined, { maximumFractionDigits: 2 }) + (r.wpmReset ? ' *' : '')
        : '—';
      const accStr = r.acc != null
        ? `${safeNumber(r.acc).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}%`
        : '—';
      const pprStr = r.pointsPerRace != null
        ? safeNumber(r.pointsPerRace).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })
        : '—';
      const totalStr = r.totalPoints != null
        ? safeNumber(r.totalPoints).toLocaleString(undefined, { maximumFractionDigits: 2 })
        : '—';
      const nitrosStr = r.nitrosDelta != null
        ? formatDeltaInt(r.nitrosDelta)
        : '—';

      const wpmTitle = r.wpmReset && r.wpmOriginal != null
        ? `title="Reset from ${safeNumber(r.wpmOriginal).toLocaleString(undefined, { maximumFractionDigits: 2 })} (> ${WPM_RESET_THRESHOLD})"`
        : '';
      const totalTitle = (r.totalPoints != null)
        ? `title="Total Points: ${safeNumber(r.totalPoints).toLocaleString(undefined, { maximumFractionDigits: 2 })}"`
        : '';

      tr.innerHTML = `
        <td data-label="Rank">${i + 1}</td>
        <td data-label="Display Name">
          <a class="link-quiet" href="${escapeAttr(racerUrl)}" target="_blank">${escapeHTML(r.displayName)}</a>
        </td>
        <td data-label="Team Tag">
          ${r.tag ? `<a class="tag-link" href="${escapeAttr(teamUrl)}" target="_blank">${escapeHTML(r.tag)}</a>` : '<span>—</span>'}
        </td>
        <td data-label="Total Races">${formatDeltaInt(r.dRaces)}</td>
        <td data-label="Avg WPM"><span ${wpmTitle}>${wpmStr}</span></td>
        <td data-label="Avg Accuracy">${accStr}</td>
        <td data-label="Avg Points">${pprStr}</td>
        <td data-label="Nitros Used">${nitrosStr}</td>
        <td data-label="Total Points"><span ${totalTitle}>${totalStr}</span></td>
      `.trim();

      frag.appendChild(tr);
    });

    tbody.appendChild(frag);

    // Optional legend for audit clarity
    const legendId = 'eventLegend';
    let legend = document.getElementById(legendId);
    if (!legend) {
      legend = document.createElement('div');
      legend.id = legendId;
      legend.className = 'table-note legend';
      legend.textContent = '* = WPM reset due to WPM Mishandling';
      const tableWrap = tbody.closest('.table-container') || tbody.parentElement;
      if (tableWrap && !tableWrap.querySelector('#' + legendId)) {
        tableWrap.appendChild(legend);
      }
    }
  }

  // -----------------------------
  // UI helpers for Event/Notes
  // -----------------------------
  function clearEventTable() {
    const tbody = document.querySelector('#eventTable tbody');
    if (tbody) tbody.innerHTML = '';
  }
  function setEventStatus(text) {
    const el = document.getElementById('eventStatus');
    if (el) el.textContent = text || '';
  }
  function setNote(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text || '';
  }

  // -----------------------------
  // Sorting (numeric-aware + rank renumbering + a11y)
  // -----------------------------
  function enableSorting(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const headers = table.querySelectorAll('th');
    headers.forEach((th, idx) => {
      th.tabIndex = 0;
      th.setAttribute('role', 'columnheader');
      th.setAttribute('aria-sort', 'none');

      const activate = () => {
        const tbody = table.querySelector('tbody');
        if (!tbody) return;
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const asc = !th.classList.contains('asc');

        rows.sort((a, b) => {
          const aText = (a.children[idx]?.textContent || '').trim();
          const bText = (b.children[idx]?.textContent || '').trim();
          const aNum = parseFloat(aText.replace(/,/g, '').replace(/[^0-9.\-]/g, ''));
          const bNum = parseFloat(bText.replace(/,/g, '').replace(/[^0-9.\-]/g, ''));
          if (!isNaN(aNum) && !isNaN(bNum)) return asc ? aNum - bNum : bNum - aNum;
          return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
        });

        headers.forEach(h => {
          h.classList.remove('asc', 'desc');
          h.setAttribute('aria-sort', 'none');
        });
        th.classList.add(asc ? 'asc' : 'desc');
        th.setAttribute('aria-sort', asc ? 'ascending' : 'descending');

        rows.forEach((row, i) => {
          if (row.children[0]) row.children[0].textContent = i + 1;
        });

        tbody.innerHTML = '';
        rows.forEach(r => tbody.appendChild(r));
      };

      th.addEventListener('click', activate);
      th.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          activate();
        }
      });
    });
  }

  // -----------------------------
  // Utilities
  // -----------------------------
  function ensureEventHeaderExact() {
    // Enforce exact THEAD structure and order to match row generation and sorting indices.
    const table = document.getElementById('eventTable');
    if (!table) return;
    let thead = table.querySelector('thead');
    if (!thead) {
      thead = document.createElement('thead');
      table.insertBefore(thead, table.firstChild);
    }
    const desired = [
      'Rank',
      'Display Name',
      'Team Tag',
      'Total Races',
      'Avg WPM',
      'Avg Accuracy',
      'Avg Points',
      'Nitros Used',
      'Total Points'
    ];
    const tr = document.createElement('tr');
    desired.forEach(text => {
      const th = document.createElement('th');
      th.textContent = text;
      tr.appendChild(th);
    });
    thead.innerHTML = '';
    thead.appendChild(tr);
  }

  function removeTotalPointsSectionIfPresent() {
    const tab = document.querySelector('.tabs .tab[data-target="eventTotalPointsSection"]');
    if (tab && tab.parentNode) tab.parentNode.removeChild(tab);
    const sec = document.getElementById('eventTotalPointsSection');
    if (sec && sec.parentNode) sec.parentNode.removeChild(sec);
  }

  function wpmFromTyped(typedDelta, racesDelta, secondsPerRace = SECONDS_PER_RACE) {
    const typed = safeNumber(typedDelta);
    const races = safeNumber(racesDelta);
    if (typed <= 0 || races <= 0) return null;
    // WPM = typed * 60 / (5 * secondsPerRace * races)
    const wpm = (typed * 60) / (5 * secondsPerRace * races);
    return Number.isFinite(wpm) && wpm > 0 ? wpm : null;
  }

  function ntRacerURL(username) {
    const slug = String(username || '').trim();
    return slug ? `https://www.nitrotype.com/racer/${encodeURIComponent(slug)}` : '#';
  }
  function ntTeamURL(tag) {
    const t = String(tag || '').trim();
    return t ? `https://www.nitrotype.com/team/${encodeURIComponent(t)}` : '#';
  }
  function prettyNameFromSlug(slug) {
    const s = String(slug || '').trim();
    if (!s) return '';
    // Light prettify: replace underscores with spaces
    return s.replace(/_/g, ' ');
  }
  function safeNumber(x) {
    const n = Number(x);
    return Number.isFinite(n) ? n : 0;
  }
  function clamp(min, v, max) {
    return Math.max(min, Math.min(max, v));
  }
  function parseLocalDate(input) {
    const raw = String(input || '').trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
      const [y, m, d] = raw.split('-').map(n => parseInt(n, 10));
      const dt = new Date(y, m - 1, d, 0, 0, 0, 0);
      if (!isNaN(dt.getTime())) return dt;
    }
    const dt2 = new Date(raw);
    if (!isNaN(dt2.getTime())) return dt2;
    return new Date();
  }
  function escapeHTML(s) {
    return String(s ?? '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }
  function escapeAttr(s) {
    return escapeHTML(s).replace(/"/g, '&quot;');
  }
  function formatDeltaInt(n) {
    const v = safeNumber(n);
    const sign = v > 0 ? '+' : '';
    return `${sign}${v.toLocaleString()}`;
  }
  function toArray(maybeArray) {
    if (Array.isArray(maybeArray)) return maybeArray;
    if (maybeArray && typeof maybeArray === 'object' && Array.isArray(maybeArray.racers)) return maybeArray.racers;
    return [];
  }
  function indexByKey(arr, keyFn) {
    const out = Object.create(null);
    for (const item of arr || []) {
      const k = String(keyFn(item) || '').toLowerCase();
      if (!k) continue;
      out[k] = item;
    }
    return out;
  }
  function pickFirstNonEmpty(arr, fallback) {
    for (const v of arr) {
      if (v !== undefined && v !== null && String(v).trim() !== '') return String(v);
    }
    return fallback;
  }
});
</script>
</body>
</html>






